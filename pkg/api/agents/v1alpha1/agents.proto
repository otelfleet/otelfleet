syntax = "proto3";
package config.v1alpha1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/otelfleet/otelfleet/pkg/api/agents/v1alpha1";

service AgentService {
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);
  rpc GetAgent(GetAgentRequest) returns (GetAgentResponse);
  rpc Status(GetAgentStatusRequest) returns (GetAgentStatusResponse);
  rpc DeleteAgent(DeleteAgentRequest) returns (google.protobuf.Empty);
}

message ListAgentsRequest {
  bool with_status = 1;
}

message ListAgentsResponse {
  repeated AgentDescriptionAndStatus agents = 1;
}

// AgentView combines registration and status for list/get responses.
// This is the preferred type name for combined agent data.
message AgentView {
  AgentRegistration registration = 1;
  AgentStatus       status       = 2;
}

// AgentDescriptionAndStatus is kept for backward compatibility.
// Use AgentView for new code.
message AgentDescriptionAndStatus {
  AgentDescription agent  = 1;
  AgentStatus      status = 2;
}

message GetAgentRequest {
  string agent_id = 1;
}

message GetAgentResponse {
  AgentDescription agent = 1;
}

message GetAgentStatusRequest {
  string agent_id = 1;
}

message GetAgentStatusResponse {
  AgentStatus status = 1;
}

message DeleteAgentRequest {
  string agent_id = 1;
}

message AgentStatus {
  AgentState         state                = 1;
  ComponentHealth    health               = 2;
  EffectiveConfig    effective_config     = 3;
  RemoteConfigStatus remote_config_status = 4;
  // New fields for unified status
  google.protobuf.Timestamp last_seen = 5;
  ConfigSyncStatus config_sync_status = 6;
  string config_sync_reason = 7;
  google.protobuf.Timestamp connected_at = 8;
  google.protobuf.Timestamp disconnected_at = 9;
}

// AgentRegistration represents the core agent identity and attributes.
// This is the preferred type name for agent registration data.
message AgentRegistration {
  string id            = 1;
  string friendly_name = 2;

  // Attributes that identify the Agent (e.g., service.name, service.version, service.instance.id).
  repeated KeyValue identifying_attributes = 3;

  // Attributes that do not necessarily identify the Agent but help describe where it runs.
  repeated KeyValue non_identifying_attributes = 4;

  repeated string capabilities = 5;
}

// AgentDescription is kept for backward compatibility.
// Use AgentRegistration for new code.
message AgentDescription {
  string id            = 1;
  string friendly_name = 2;

  // Attributes that identify the Agent (e.g., service.name, service.version, service.instance.id).
  // These attributes uniquely identify the agent and should be used for its own telemetry.
  repeated KeyValue identifying_attributes = 3;

  // Attributes that do not necessarily identify the Agent but help describe where it runs
  // (e.g., os.type, os.version, host.*, cloud.*).
  repeated KeyValue non_identifying_attributes = 4;

  repeated string capabilities = 5;
}

// KeyValue represents a key-value pair with support for various value types.
message KeyValue {
  string   key   = 1;
  AnyValue value = 2;
}

// AnyValue represents a value that can be one of several types.
message AnyValue {
  oneof value {
    string       string_value = 1;
    bool         bool_value   = 2;
    int64        int_value    = 3;
    double       double_value = 4;
    bytes        bytes_value  = 5;
    ArrayValue   array_value  = 6;
    KeyValueList kvlist_value = 7;
  }
}

// ArrayValue holds an array of AnyValue.
message ArrayValue {
  repeated AnyValue values = 1;
}

// KeyValueList holds a list of KeyValue pairs.
message KeyValueList {
  repeated KeyValue values = 1;
}

enum AgentState {
  AGENT_STATE_UNKNOWN      = 0;
  AGENT_STATE_CONNECTED    = 1;
  AGENT_STATE_DISCONNECTED = 2;
}

// ConfigSyncStatus represents the unified config synchronization status.
// This is server-computed based on comparing assigned config hash with agent-reported hash.
enum ConfigSyncStatus {
  CONFIG_SYNC_STATUS_UNKNOWN     = 0;  // No assignment or unable to determine
  CONFIG_SYNC_STATUS_IN_SYNC     = 1;  // Assigned config hash matches reported hash and status is APPLIED
  CONFIG_SYNC_STATUS_OUT_OF_SYNC = 2;  // Hash mismatch or no status reported
  CONFIG_SYNC_STATUS_APPLYING    = 3;  // Agent is currently applying the config
  CONFIG_SYNC_STATUS_ERROR       = 4;  // Agent reported failure applying config
}

// AgentConnectionState represents the persisted connection state of an agent.
// This replaces the in-memory AgentTracker state.
message AgentConnectionState {
  string agent_id = 1;
  AgentState state = 2;
  google.protobuf.Timestamp last_seen = 3;
  google.protobuf.Timestamp connected_at = 4;
  google.protobuf.Timestamp disconnected_at = 5;
  bytes instance_uid = 6;
  uint64 capabilities = 7;
  uint64 sequence_num = 8;
}

// ComponentHealth represents the health status of an agent and its components.
message ComponentHealth {
  bool   healthy               = 1;
  uint64 start_time_unix_nano  = 2;
  string last_error            = 3;
  string status                = 4;
  uint64 status_time_unix_nano = 5;
  map<string, ComponentHealth> component_health_map = 6;
}

// EffectiveConfig represents the current effective configuration of an agent.
message EffectiveConfig {
  AgentConfigMap config_map = 1;
}

// AgentConfigMap holds a map of config file names to their content.
message AgentConfigMap {
  map<string, AgentConfigFile> config_map = 1;
}

// AgentConfigFile represents a single configuration file.
message AgentConfigFile {
  bytes  body         = 1;
  string content_type = 2;
}

// RemoteConfigStatus represents the status of a remote configuration on an agent.
message RemoteConfigStatus {
  bytes                last_remote_config_hash = 1;
  RemoteConfigStatuses status                  = 2;
  string               error_message           = 3;
}

enum RemoteConfigStatuses {
  REMOTE_CONFIG_STATUSES_UNSET    = 0;
  REMOTE_CONFIG_STATUSES_APPLIED  = 1;
  REMOTE_CONFIG_STATUSES_APPLYING = 2;
  REMOTE_CONFIG_STATUSES_FAILED   = 3;
}
